<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Adbase: 快速入门</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Adbase"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Adbase
   </div>
   <div id="projectbrief">Adinf C++ base library V2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.php" method="get">
              <img id="MSearchSelect" src="search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('quickstart.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">快速入门 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#install">安装</a><ul><li class="level2"><a href="#install_gcc">安装 gcc 4.8+</a></li>
<li class="level2"><a href="#installadbase">安装 adbase</a></li>
</ul>
</li>
<li class="level1"><a href="#firstproject">生成第一个 C++ 项目</a><ul><li class="level2"><a href="#创建项目">创建项目</a></li>
<li class="level2"><a href="#timer_hello">实现定时器输出 hello world</a></li>
<li class="level2"><a href="#adserver_hello">实现大小写转化 Server</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="install"></a>
安装</h1>
<p>安装 adbase 需要的系统环境：</p>
<ul>
<li>gcc 4.8+ </li>
<li>cmake 2.6.4+ </li>
<li>libevent-2.0.22+ </li>
<li>librdkafka-0.9.0+ (非必需) <dl class="section note"><dt>Note</dt><dd>librdkafka 只有编译生成 libadbase_kafka 时需要该依赖，如果不使用 AIMS 相关模块，可以不依赖该库</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="install_gcc"></a>
安装 gcc 4.8+</h2>
<p>如果系统中有 gcc 4.8+ 的编译环境可以跳过本节</p>
<dl class="section user"><dt>安装过程</dt><dd></dd></dl>
<ul>
<li>下载 gcc 4.8 的源码 <div class="fragment"><div class="line">wget http: <span class="comment">//ftp.gnu.org/gnu/gcc/gcc-4.8.4/gcc-4.8.4.tar.bz2</span></div><div class="line">tar -jxvf  gcc-4.8.4.tar.bz2</div></div><!-- fragment --></li>
</ul>
<ul>
<li>下载编译所需依赖库 <div class="fragment"><div class="line">cd gcc-4.8.0</div><div class="line">./contrib/download_prerequisites</div><div class="line">cd ..</div></div><!-- fragment --></li>
</ul>
<ul>
<li>建立编译输出目录 <div class="fragment"><div class="line">mkdir build</div></div><!-- fragment --></li>
</ul>
<ul>
<li>进入此目录，执行以下命令，生成 makefile 文件 <div class="fragment"><div class="line">cd  build</div><div class="line">../configure --prefix=/usr/local/adinf/gcc4.8 --enable-checking=release --enable-languages=c,c++</div><div class="line"><span class="preprocessor"># 如果不要32bit交叉编译环境可以加--disable-multilib 编译选项</span></div></div><!-- fragment --></li>
</ul>
<ul>
<li>编译 <div class="fragment"><div class="line"><span class="preprocessor"># j 后面的是核心数，编译速度会比较快</span></div><div class="line"><span class="preprocessor">make -j 12</span></div></div><!-- fragment --></li>
</ul>
<ul>
<li>安装 <div class="fragment"><div class="line">sudo make install</div></div><!-- fragment --></li>
</ul>
<dl class="section user"><dt>安装编译常见问题</dt><dd></dd></dl>
<ul>
<li>报错gnu/stubs-32.h no such file or directory </li>
<li>解决办法：命令 yum install glibc-devel.i686问题解决</li>
</ul>
<h2><a class="anchor" id="installadbase"></a>
安装 adbase</h2>
<ul>
<li>下载 adbase 源码 <div class="fragment"><div class="line">git clone git@github.com:weiboad/<a class="code" href="d6/dd3/namespaceadbase.html">adbase</a>.git</div></div><!-- fragment --></li>
</ul>
<ul>
<li>配置项目 <div class="fragment"><div class="line">[zhongxiu@bpdev adbase_v2]$ ./cmake.sh</div><div class="line">Start cmake configure.....</div><div class="line">编译 Debug 级别 [Debug(D)|Release(R)]: R   # D -&gt; debug R -&gt; release</div><div class="line">编译环境[32bit(32)|64bit(64)]: 64</div><div class="line">安装 adbase_kafka 模块 [Y|N]: y </div><div class="line">是否是开发模式 [Y|N]: n</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>如果使用 AIMS 相关模块请安装 adbase_kafka</dd></dl>
</li>
<li>编译并安装 <div class="fragment"><div class="line">cd build</div><div class="line">make -j 12</div><div class="line">make install</div></div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="firstproject"></a>
生成第一个 C++ 项目</h1>
<p>adbase 提供 seed 项目模块可以自动生成项目的基础代码，达到快速开发，开发人员仅需配置需要的项目可选模块即可生成, 在本次 demo 中准备编写一个字符串大小写转化的 Server, 并且创建一个每秒打印 "hello word" 的定时器, 通过分解项目得出需要两个模块分别是 adserver、timer, 暂定项目名称为 hello</p>
<h2><a class="anchor" id="创建项目"></a>
创建项目</h2>
<ul>
<li>创建项目目录 <div class="fragment"><div class="line">mkdir hello</div><div class="line">cd hello</div></div><!-- fragment --></li>
</ul>
<ul>
<li>创建配置文件 adbase.ini <div class="fragment"><div class="line">[project]</div><div class="line">; 项目名称</div><div class="line">ADINF_PROJECT_NAME=hello</div><div class="line">; 项目描述</div><div class="line">ADINF_PROJECT_SUMMARY=Weibo adinf hello</div><div class="line">; 项目主页</div><div class="line">ADINF_PROJECT_URL=http:<span class="comment">//adinf.weiboad.org</span></div><div class="line">; 项目打包相关信息</div><div class="line">ADINF_PROJECT_VENDOR=zhongxiu  &lt;zhongxiu@staff.weibo.com&gt;</div><div class="line">ADINF_PROJECT_PACKAGER=zhongxiu  &lt;zhongxiu@staff.weibo.com&gt;</div><div class="line"></div><div class="line">[module]</div><div class="line">; 是否生成 adserver 模块代码</div><div class="line">adserver=yes</div><div class="line">; 是否生成 timer 模块代码</div><div class="line">timer=yes</div><div class="line">; 是否生成 aims consumer 模块代码</div><div class="line">kafkac=no</div><div class="line">; 是否生成 aims producer 模块代码</div><div class="line">kafkap=no</div><div class="line">; 是否生成 aims logging 模块代码 (强烈推荐开启)</div><div class="line">logging=yes</div><div class="line"></div><div class="line">[params]</div><div class="line">; 对于 timer 模块该参数生效，定时器名称，多个定时器用逗号分隔</div><div class="line">timers=print</div><div class="line">; 对于 adserver 模块该参数生效，http server 的 controller 名称, 多个用逗号分隔</div><div class="line">http_controllers=Index</div><div class="line">; 对于 aims consumer 模块该参数生效，分别是kafka consumer 名称、topic、groupid, 多个用逗号分隔, 三个参数的个数必须一一对应</div><div class="line">kafka_consumers=Out</div><div class="line">kafka_consumers_topics=test</div><div class="line">kafka_consumers_groups=test_cpp</div><div class="line">; 对于 aims producer 模块该参数生效，分别是kafka producer 名称、topic, 多个用逗号分隔, 两个参数的个数必须一一对应</div><div class="line">kafka_producers=In</div><div class="line">kafka_producers_topics=test</div><div class="line"></div><div class="line">[files]</div><div class="line">src/main.cpp=src/@ADINF_PROJECT_NAME@.cpp</div><div class="line">rpm/main.spec.in=rpm/@ADINF_PROJECT_NAME@.spec.in</div><div class="line"></div><div class="line">[execs]</div><div class="line">cmake.sh=1</div><div class="line">build_rpm.in=1</div></div><!-- fragment --></li>
</ul>
<ul>
<li>生成项目 <div class="fragment"><div class="line">[zhongxiu@bpdev hello]$ /usr/local/bin/adbase_skeleton</div><div class="line">20160718 10:33:24.402927Z 139970968688992 INFO  ./ - Seed.cpp:714</div><div class="line">Generate file list:</div><div class="line">    ./rpm/hello.spec.in</div><div class="line">    ./rpm/build_rpm.in</div><div class="line">    ./src/Timer.hpp</div><div class="line">    ./src/BootStrap.cpp</div><div class="line">    ./src/HeadProcessor.cpp</div><div class="line">    ./src/AdbaseConfig.hpp</div><div class="line">    ./src/McProcessor.hpp</div><div class="line">    ./src/hello.cpp</div><div class="line">    ./src/Http.hpp</div><div class="line">    ./src/AdServer.hpp</div><div class="line">    ./src/McProcessor.cpp</div><div class="line">    ./src/HeadProcessor.hpp</div><div class="line">    ./src/AdServer.cpp</div><div class="line">    ./src/Http/Index.hpp</div><div class="line">    ./src/Http/Server.cpp</div><div class="line">    ./src/Http/HttpInterface.hpp</div><div class="line">    ./src/Http/Server.hpp</div><div class="line">    ./src/Http/Index.cpp</div><div class="line">    ./src/Http/HttpInterface.cpp</div><div class="line">    ./src/Timer.cpp</div><div class="line">    ./src/BootStrap.hpp</div><div class="line">    ./src/CMakeLists.txt</div><div class="line">    ./src/App.hpp</div><div class="line">    ./src/App.cpp</div><div class="line">    ./src/Http.cpp</div><div class="line">    ./src/Version.hpp.in</div><div class="line">    ./conf/system.ini</div><div class="line">    ./cmake.sh</div><div class="line">    ./CMakeLists.txt</div></div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="timer_hello"></a>
实现定时器输出 hello world</h2>
<p>adbase 在生成定时器代码默认会生成 Timer.cpp Timer.hpp 两个文件，Timer 类中的 print 是本次项目在生成前配置的该项目的一个定时器，所以仅需在该回调函数中实现定时器逻辑即可</p>
<ul>
<li>修改 Timer.cpp <div class="fragment"><div class="line"><span class="keywordtype">void</span> Timer::print(<span class="keywordtype">void</span>*) {</div><div class="line">    <a class="code" href="d8/dff/group__logging.html#gaeb4f36db01bd128c7afeac5889dac311">LOG_INFO</a> &lt;&lt; <span class="stringliteral">&quot;Hello world&quot;</span>;</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
<ul>
<li>修改配置文件 将时间间隔设置为 1000ms <div class="fragment"><div class="line">[timer]</div><div class="line">; 单位ms</div><div class="line">intervalPrint = 1000</div><div class="line">[logging]</div><div class="line">logsDir=logs/</div><div class="line">; 日志分卷大小</div><div class="line">logRollSize=52428800</div><div class="line">; 1: <a class="code" href="d8/dff/group__logging.html#gaf7abc145380f1916838e42f9272aa0f6">LOG_TRACE</a> 2: <a class="code" href="d8/dff/group__logging.html#ga6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a> 3: <a class="code" href="d8/dff/group__logging.html#gaeb4f36db01bd128c7afeac5889dac311">LOG_INFO</a></div><div class="line">logLevel=1</div><div class="line">; 将日志异步写关闭，以便调试</div><div class="line">isAsync=no</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>将日志异步写关闭，以便调试 isAsync=no</dd></dl>
</li>
<li>编译运行 <div class="fragment"><div class="line">[zhongxiu@bpdev hello]$ ./cmake.sh</div><div class="line">Start cmake configure.....</div><div class="line">编译 Debug 级别 [Debug(D)|Release(R)]: D</div><div class="line">....</div><div class="line">[zhongxiu@bpdev build]$ make -j 12</div><div class="line">Scanning dependencies of target hello</div><div class="line">[  9%] [ 18%] [ 36%] [ 36%] [ 45%] [ 54%] [ 63%] [ 72%] Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/BootStrap.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/hello.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/App.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/Http.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/Http/Server.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/Http/HttpInterface.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/AdServer.o</div><div class="line">[ 81%] [ 90%] Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/Http/Index.o</div><div class="line">[100%] Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/McProcessor.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/Timer.o</div><div class="line">Building CXX <span class="keywordtype">object</span> bin/CMakeFiles/hello.dir/HeadProcessor.o</div><div class="line">[100%] Built target hello</div><div class="line">[zhongxiu@bpdev build]$ ./bin/hello -c ../conf/system.ini</div><div class="line">20160718 18:46:25.122239 140572416194912 TRACE initHttp Init http server, host:0.0.0.0 port:10010 - AdServer.cpp:87</div><div class="line">20160718 18:46:25.122375 140572416194912 DEBUG Server Init Http Server. - Server.cpp:46</div><div class="line">20160718 18:46:25.122412 140572416194912 DEBUG registerLocation Server Location: /server/status <span class="keyword">register</span> success. - Server.cpp:234</div><div class="line">20160718 18:46:25.122430 140572416194912 DEBUG registerLocation Server Location: /index/index <span class="keyword">register</span> success. - Server.cpp:234</div><div class="line">20160718 18:46:25.122483 140572416194912 DEBUG Acceptor Bind: 0.0.0.0:10011 - Acceptor.cpp:29</div><div class="line">20160718 18:46:25.122669 140572405700352 DEBUG threadFunc Start create base <span class="keyword">event</span>. - Server.cpp:116</div><div class="line">20160718 18:46:25.122764 140572405700352 TRACE threadFunc Worker start. - Server.cpp:130</div><div class="line">20160718 18:46:25.122783 140572405700352 DEBUG threadFunc Start create <span class="keyword">new</span> evhttp. - Server.cpp:132</div><div class="line">....</div><div class="line">20160718 18:46:28.154159 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:29.154325 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:30.154650 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:31.155244 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:32.155849 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:33.156313 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:34.156995 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:35.157595 140572416194912 INFO  Hello world - Timer.cpp:58</div><div class="line">20160718 18:46:36.158060 140572416194912 INFO  Hello world - Timer.cpp:58</div></div><!-- fragment --> 通过查看日志完成了每个一秒打印一行 hello world 的功能</li>
</ul>
<h2><a class="anchor" id="adserver_hello"></a>
实现大小写转化 Server</h2>
<p>默认 adserver 会同时支持 http / memecache / adhead ，在这个例子中将全部实现</p>
<ul>
<li>实现 Http server <br />
实现http server 大小写转化接口在 Index 的 controller 中实现 convert Action 函数, 请求访问地址 /index/convert, 请求参数 method=lower 转化为小写, method=upper 转化为大写，data=数据. 例如 /index/convert?method=upper&amp;data=abc <pre class="fragment">- 修改 Http/Index.hpp
</pre> <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a2cd8ca36b610e7028c153587d7baa4b9">convert</a>(<a class="code" href="d6/d3f/classadbase_1_1http_1_1_request.html">adbase::http::Request</a>* request, <a class="code" href="d0/d13/classadbase_1_1http_1_1_response.html">adbase::http::Response</a>* response, <span class="keywordtype">void</span>*);</div></div><!-- fragment --></li>
</ul>
<ul>
<li>修改 Http/Index.cpp <div class="fragment"><div class="line"><span class="comment">// {{{ void Index::convert()</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a2cd8ca36b610e7028c153587d7baa4b9">Index::convert</a>(<a class="code" href="d6/d3f/classadbase_1_1http_1_1_request.html">adbase::http::Request</a>* request, <a class="code" href="d0/d13/classadbase_1_1http_1_1_response.html">adbase::http::Response</a>* response, <span class="keywordtype">void</span>*) {</div><div class="line">    std::string method = request-&gt;<a class="code" href="d6/d3f/classadbase_1_1http_1_1_request.html#ac5689ccc3c04a186fa5d9500de6f61dc">getQuery</a>(<span class="stringliteral">&quot;method&quot;</span>);</div><div class="line">    <span class="keywordtype">bool</span> isLower = <span class="keyword">false</span>;</div><div class="line">    <span class="keywordflow">if</span> (method.compare(<span class="stringliteral">&quot;lower&quot;</span>) == 0) {</div><div class="line">        isLower = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    std::string data = request-&gt;<a class="code" href="d6/d3f/classadbase_1_1http_1_1_request.html#ac5689ccc3c04a186fa5d9500de6f61dc">getQuery</a>(<span class="stringliteral">&quot;data&quot;</span>);</div><div class="line">    <span class="keywordflow">if</span> (isLower) {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(data.begin(), data.end(), data.begin(), ::tolower);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(data.begin(), data.end(), data.begin(), ::toupper);</div><div class="line">    }</div><div class="line">    responseJson(response, data, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">true</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// }}}  </span></div></div><!-- fragment --></li>
<li>修改 Http/Index.cpp <div class="fragment"><div class="line"><span class="comment">// {{{ void Index::registerLocation()</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> Index::registerLocation(<a class="code" href="df/dd4/classadbase_1_1http_1_1_server.html">adbase::http::Server</a>* http) {</div><div class="line">    ADSERVER_HTTP_ADD_API(http, Index, index);</div><div class="line">    ADSERVER_HTTP_ADD_API(http, Index, <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a2cd8ca36b610e7028c153587d7baa4b9">convert</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// }}}</span></div></div><!-- fragment --></li>
<li>编译运行并测试 <div class="fragment"><div class="line">[zhongxiu@bpdev adbase_v2]$ curl <span class="stringliteral">&#39;127.0.0.1:10010/index/convert?method=lower&amp;data=ABC&#39;</span></div><div class="line">{<span class="stringliteral">&quot;code&quot;</span>:0,<span class="stringliteral">&quot;baseid&quot;</span>:290655402196992,<span class="stringliteral">&quot;data&quot;</span>:<span class="stringliteral">&quot;abc&quot;</span>,<span class="stringliteral">&quot;msg&quot;</span>:<span class="stringliteral">&quot;&quot;</span>}</div><div class="line">[zhongxiu@bpdev adbase_v2]$</div></div><!-- fragment --></li>
</ul>
<ul>
<li>实现 Memcache server <br />
实现Memcache 协议的计算，在当前大小写转化的需求中可以使用 memecache 的 get 命令，加入定位用 # 号分隔操作参数，如 lower::ABC 代表将 ABC 字符串转化为小写<ul>
<li>修改 McProcessor.cpp <div class="fragment"><div class="line"><span class="comment">// {{{ adbase::mc::ProtocolBinaryResponseStatus McProcessor::get()</span></div><div class="line"></div><div class="line"><a class="code" href="d5/d64/namespaceadbase_1_1mc.html#a5ac2be8ff0fc3b0395455019cc429af9">adbase::mc::ProtocolBinaryResponseStatus</a> McProcessor::get(<span class="keyword">const</span> <span class="keywordtype">void</span>* key,</div><div class="line">            uint16_t keylen,</div><div class="line">            <a class="code" href="d6/dc4/classadbase_1_1_buffer.html">adbase::Buffer</a> *data) {</div><div class="line">    std::string keyData(static_cast&lt;const char*&gt;(key), static_cast&lt;size_t&gt;(keylen));</div><div class="line">    std::vector&lt;std::string&gt; infos = <a class="code" href="d7/d6a/group__utility.html#ga6ec8d3ccf473627722788a0c64dc8f52">adbase::explode</a>(keyData, <span class="charliteral">&#39;#&#39;</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="keywordflow">if</span> (infos.size() != 2) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="d5/d64/namespaceadbase_1_1mc.html#a5ac2be8ff0fc3b0395455019cc429af9a16e589b97bccde9589a07c8cd8e3283a">adbase::mc::PROTOCOL_BINARY_RESPONSE_NOT_SUPPORTED</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">bool</span> isLower = <span class="keyword">false</span>;</div><div class="line">    <span class="keywordflow">if</span> (infos[0].compare(<span class="stringliteral">&quot;lower&quot;</span>) == 0) {</div><div class="line">        isLower = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    std::string convertStr = infos[1];</div><div class="line">    <span class="keywordflow">if</span> (isLower) {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(convertStr.begin(), convertStr.end(), convertStr.begin(), ::tolower);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(convertStr.begin(), convertStr.end(), convertStr.begin(), ::toupper);</div><div class="line">    }</div><div class="line">    data-&gt;<a class="code" href="d6/dc4/classadbase_1_1_buffer.html#adc1357c98d3c8aae3e6c8f43d338149b">append</a>(static_cast&lt;const char*&gt;(convertStr.c_str()), static_cast&lt;size_t&gt;(convertStr.size()));</div><div class="line">    <a class="code" href="d8/dff/group__logging.html#gaeb4f36db01bd128c7afeac5889dac311">LOG_INFO</a> &lt;&lt; <span class="stringliteral">&quot;Mc GET key:&quot;</span> &lt;&lt; keyData;</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="d5/d64/namespaceadbase_1_1mc.html#a5ac2be8ff0fc3b0395455019cc429af9a91b9f8477f79af664cc7431690e6fa26">adbase::mc::PROTOCOL_BINARY_RESPONSE_SUCCESS</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// }}}</span></div></div><!-- fragment --></li>
<li>编译运行并测试 <div class="fragment"><div class="line">[zhongxiu@bpdev adbase_v2]$ telnet 127.0.0.1 10011</div><div class="line">Trying 127.0.0.1...</div><div class="line">Connected to 127.0.0.1.</div><div class="line">Escape character is <span class="stringliteral">&#39;^]&#39;</span>.</div><div class="line">get lower#ABC</div><div class="line">VALUE lower#ABC 0 3</div><div class="line">abc</div><div class="line">END</div><div class="line"><span class="keyword">get</span> upper#eeee</div><div class="line">VALUE upper#eeee 0 4</div><div class="line">EEEE</div><div class="line">END</div><div class="line"><span class="keyword">get</span> errorkey</div><div class="line">VALUE errorkey 0 0</div><div class="line"></div><div class="line">END</div></div><!-- fragment --></li>
</ul>
</li>
</ul>
<ul>
<li>实现 Adhead server <br />
Adhead 基本和 Memcache 一致通过发送 lower::ABC 代表将 ABC 转化为小写<ul>
<li>修改 HeadProcessor.cpp <div class="fragment"><div class="line"><span class="comment">// {{{ adbase::head::ProtocolBinaryResponseStatus HeadProcessor::readHandler()</span></div><div class="line"></div><div class="line"><a class="code" href="d3/d94/namespaceadbase_1_1head.html#a7f37157dc84ac94995c05b492ea0f8b8">adbase::head::ProtocolBinaryResponseStatus</a> HeadProcessor::readHandler(<a class="code" href="d3/d94/namespaceadbase_1_1head.html#aafbb8fa33fdf62fb1273865999abac50">adbase::head::ProtocolBinaryDataType</a> datatype,</div><div class="line">        <span class="keyword">const</span> <span class="keywordtype">void</span> *data,</div><div class="line">        ssize_t datalen,</div><div class="line">        <a class="code" href="d3/d94/namespaceadbase_1_1head.html#aafbb8fa33fdf62fb1273865999abac50">adbase::head::ProtocolBinaryDataType</a>* resDataType,</div><div class="line">        <a class="code" href="d6/dc4/classadbase_1_1_buffer.html">adbase::Buffer</a>* responseData) {</div><div class="line">    (void)datatype;</div><div class="line">    std::string msgData(static_cast&lt;const char*&gt;(data), static_cast&lt;size_t&gt;(datalen));</div><div class="line">    std::vector&lt;std::string&gt; infos = <a class="code" href="d7/d6a/group__utility.html#ga6ec8d3ccf473627722788a0c64dc8f52">adbase::explode</a>(msgData, <span class="charliteral">&#39;#&#39;</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="keywordflow">if</span> (infos.size() != 2) {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="d3/d94/namespaceadbase_1_1head.html#a7f37157dc84ac94995c05b492ea0f8b8aa3649c2d6ac72bfeba8e4d8b95b465f4">adbase::head::PROTOCOL_BINARY_RESPONSE_NOT_SUPPORTED</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordtype">bool</span> isLower = <span class="keyword">false</span>;</div><div class="line">    <span class="keywordflow">if</span> (infos[0].compare(<span class="stringliteral">&quot;lower&quot;</span>) == 0) {</div><div class="line">        isLower = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    std::string convertStr = infos[1];</div><div class="line">    <span class="keywordflow">if</span> (isLower) {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(convertStr.begin(), convertStr.end(), convertStr.begin(), ::tolower);</div><div class="line">    } <span class="keywordflow">else</span> {</div><div class="line">        <a class="code" href="d6/d34/namespaceadbase_1_1detail.html#a9f9373da01a2036be59eeeeda00f1567">std::transform</a>(convertStr.begin(), convertStr.end(), convertStr.begin(), ::toupper);</div><div class="line">    }</div><div class="line">     *resDataType = <a class="code" href="d3/d94/namespaceadbase_1_1head.html#aafbb8fa33fdf62fb1273865999abac50a2a6bfeac9890ec072fb6a9e03466fe19">adbase::head::PROTOCOL_BINARY_TYPE_ASCII</a>;</div><div class="line">    responseData-&gt;<a class="code" href="d6/dc4/classadbase_1_1_buffer.html#adc1357c98d3c8aae3e6c8f43d338149b">append</a>(convertStr);</div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="d3/d94/namespaceadbase_1_1head.html#a7f37157dc84ac94995c05b492ea0f8b8a48c539b4d5d156ceb2b5e5e16cab73a2">adbase::head::PROTOCOL_BINARY_RESPONSE_SUCCESS</a>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// }}}</span></div></div><!-- fragment --></li>
<li>编译运行并测试 <div class="fragment"><div class="line"><span class="comment">// 通过 php adhead 测试如下：</span></div><div class="line">use \Adinf\Adhead\Factory as AdheadFactory;</div><div class="line">use \Adinf\Adhead\Protocol\Protocol as AdheadProtocol;</div><div class="line"></div><div class="line">$start = microtime(<span class="keyword">true</span>);</div><div class="line">AdheadFactory::init();</div><div class="line">$adhead = AdheadFactory::adhead(AdheadFactory::ADHEAD_SYNC, <span class="stringliteral">&quot;127.0.0.1&quot;</span>, 10012);</div><div class="line">$adhead-&gt;setRecvTimeoutSec(100);</div><div class="line"></div><div class="line">$input = <span class="stringliteral">&#39;lower#ABC&#39;</span>;</div><div class="line">$adhead-&gt;write(11, $input, AdheadProtocol::DATATYPE_JSON);</div><div class="line">$data = $adhead-&gt;read();</div><div class="line">var_dump($data);</div><div class="line">$input = <span class="stringliteral">&#39;upper#eeee&#39;</span>;</div><div class="line">$adhead-&gt;write(11, $input, AdheadProtocol::DATATYPE_JSON);</div><div class="line">$data = $adhead-&gt;read();</div><div class="line">var_dump($data);</div><div class="line">$end = microtime(<span class="keyword">true</span>);</div><div class="line">var_dump($end - $start);    </div><div class="line"></div><div class="line">Result:</div><div class="line">array(3) {</div><div class="line">  <span class="stringliteral">&#39;type&#39;</span> =&gt;</div><div class="line">  int(0)</div><div class="line">  <span class="stringliteral">&#39;status&#39;</span> =&gt;</div><div class="line">  int(0)</div><div class="line">  <span class="stringliteral">&#39;data&#39;</span> =&gt;</div><div class="line">  string(3) <span class="stringliteral">&quot;abc&quot;</span></div><div class="line">}</div><div class="line">array(3) {</div><div class="line">  <span class="stringliteral">&#39;type&#39;</span> =&gt;</div><div class="line">  int(0)</div><div class="line">  <span class="stringliteral">&#39;status&#39;</span> =&gt;</div><div class="line">  int(0)</div><div class="line">  <span class="stringliteral">&#39;data&#39;</span> =&gt;</div><div class="line">  string(4) <span class="stringliteral">&quot;EEEE&quot;</span></div><div class="line">}</div><div class="line">double(0.0049090385437012)</div></div><!-- fragment --> </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Feb 15 2017 18:13:49 for Adbase by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Adbase: Seed 项目生成器使用</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    if ($('.searchresults').length > 0) { searchBox.DOMSearchField().focus(); }
  });
</script>
<link rel="search" href="search_opensearch.php?v=opensearch.xml" type="application/opensearchdescription+xml" title="Adbase"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Adbase
   </div>
   <div id="projectbrief">Adinf C++ base library V2</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
          <div class="left">
            <form id="FSearchBox" action="search.php" method="get">
              <img id="MSearchSelect" src="search/mag.png" alt=""/>
              <input type="text" id="MSearchField" name="query" value="Search" size="20" accesskey="S" 
                     onfocus="searchBox.OnSearchFieldFocus(true)" 
                     onblur="searchBox.OnSearchFieldFocus(false)"/>
            </form>
          </div><div class="right"></div>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('seed.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Seed 项目生成器使用 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#seed_sk_config">生成项目配置项</a></li>
<li class="level1"><a href="#seed_app">项目入口介绍</a></li>
<li class="level1"><a href="#seed_context">项目 Context</a></li>
<li class="level1"><a href="#seed_config">引入项目配置项</a></li>
<li class="level1"><a href="#seed_http">HttpServer</a></li>
<li class="level1"><a href="#seed_mc">McServer</a></li>
<li class="level1"><a href="#seed_head">AdheadServer</a></li>
<li class="level1"><a href="#seed_aims_in">AIMS IN</a></li>
<li class="level1"><a href="#seed_aims_out">AIMS OUT</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="seed_sk_config"></a>
生成项目配置项</h1>
<p>在利用 adbase_skeleton 生成项目代码时需要在当前目录中编写生成项目的配置文件 adbase.ini 如下将详细解释配置文件的配置项</p>
<div class="fragment"><div class="line">[project]</div><div class="line">; 项目名称</div><div class="line">ADINF_PROJECT_NAME=hello</div><div class="line">; 项目描述</div><div class="line">ADINF_PROJECT_SUMMARY=Weibo adinf hello</div><div class="line">; 项目主页</div><div class="line">ADINF_PROJECT_URL=http:<span class="comment">//adinf.weiboad.org</span></div><div class="line">; 项目打包相关信息</div><div class="line">ADINF_PROJECT_VENDOR=zhongxiu  &lt;zhongxiu@staff.weibo.com&gt;</div><div class="line">ADINF_PROJECT_PACKAGER=zhongxiu  &lt;zhongxiu@staff.weibo.com&gt;</div><div class="line"></div><div class="line">[module]</div><div class="line">; 是否生成 adserver 模块代码</div><div class="line">adserver=yes</div><div class="line">; 是否生成 timer 模块代码</div><div class="line">timer=yes</div><div class="line">; 是否生成 aims consumer 模块代码</div><div class="line">kafkac=no</div><div class="line">; 是否生成 aims producer 模块代码</div><div class="line">kafkap=no</div><div class="line">; 是否生成 aims logging 模块代码 (强烈推荐开启)</div><div class="line">logging=yes</div><div class="line"></div><div class="line">[params]</div><div class="line">; 对于 timer 模块该参数生效，定时器名称，多个定时器用逗号分隔</div><div class="line">timers=print</div><div class="line">; 对于 adserver 模块该参数生效，http server 的 controller 名称, 多个用逗号分隔</div><div class="line">http_controllers=Index</div><div class="line">; 对于 aims consumer 模块该参数生效，分别是kafka consumer 名称、topic、groupid, 多个用逗号分隔, 三个参数的个数必须一一对应</div><div class="line">kafka_consumers=Out</div><div class="line">kafka_consumers_topics=test</div><div class="line">kafka_consumers_groups=test_cpp</div><div class="line">; 对于 aims producer 模块该参数生效，分别是kafka producer 名称、topic, 多个用逗号分隔, 两个参数的个数必须一一对应</div><div class="line">kafka_producers=In</div><div class="line">kafka_producers_topics=test</div><div class="line"></div><div class="line">[files]</div><div class="line">src/main.cpp=src/@ADINF_PROJECT_NAME@.cpp</div><div class="line">rpm/main.spec.in=rpm/@ADINF_PROJECT_NAME@.spec.in</div><div class="line"></div><div class="line">[execs]</div><div class="line">cmake.sh=1</div><div class="line">build_rpm.in=1</div></div><!-- fragment --><p>整个配置文件中分为 project、module、params、files、execs 配置段，一般情况下我们只需关注修改 project、module、params 即可满足项目需求</p>
<ul>
<li>project 定义配置项目的名称、打包信息等 </li>
<li>module 配置生成代码包含的模块 </li>
<li>params 配置 module 段中模块的详细参数配置</li>
</ul>
<h1><a class="anchor" id="seed_app"></a>
项目入口介绍</h1>
<dl class="section user"><dt>类似于 main 函数入口一样，该框架也有一个程序入口，该入口是在 main 做了封装的回调入口，Seed 代码生成器将常规的信号处理主线程事件监听都做了，用户只需在程序入口初始化自己的业务模块即可.</dt><dd></dd></dl>
<dl class="section user"><dt>程序入口位于 src/App.cpp ，src/App.hpp 中，该对象中有 run/reload/~App/setAdServerContext/setAimsContext/setTimerContext 等方法</dt><dd></dd></dl>
<ul>
<li>run() 该函数为程序入口，类似于main入口，用户可以在该函数中初始化对象等。 </li>
<li>~App() 该函数是 App 对象的析构函数，可以在该函数中做一些资源销毁回收工作在程序停止的时候 </li>
<li>reload() 该函数的作用是当给程序发送 USR1 的信号时会重载配置文件，默认框架仅仅会将日志级别重载，用户可以根据业务需要重载其他配置 </li>
<li>setAdServerContext() 设置 Adserver 的 context， <a class="el" href="seed.html#seed_context">项目 Context</a> 详细解释 </li>
<li>setAimsContext() 设置 AIMS 的 context， <a class="el" href="seed.html#seed_context">项目 Context</a> 详细解释 </li>
<li>setTimerContext() 设置 Timer 的 context，<a class="el" href="seed.html#seed_context">项目 Context</a> 详细解释 </li>
<li>loadConfig() 用来加载用户自定义的配置项, <a class="el" href="seed.html#seed_config">引入项目配置项</a> 详细解释</li>
</ul>
<dl class="section user"><dt>改节用户重点理解 run() / ~App() / reload() 作用和用法即可，其他函数将在后面讲解</dt><dd></dd></dl>
<dl class="section user"><dt>例如在 run 中初始化 app::Topic, app::Message 等对象</dt><dd><div class="fragment"><div class="line"><span class="keywordtype">void</span> App::run() {</div><div class="line">    _topic   = <span class="keyword">new</span> app::Topic();</div><div class="line">    _message = <span class="keyword">new</span> app::Message(_configure);</div><div class="line">    _config  = <span class="keyword">new</span> app::Config();</div><div class="line">    _message-&gt;loadMessage();</div><div class="line">}</div></div><!-- fragment --></dd></dl>
<dl class="section note"><dt>Note</dt><dd>App::run() 函数仅仅执行一次在程序启动的时候，并且运行在主线程中，由于主线程在运行完 run 函数后交由框架做一些如事件循环等操作，所以不要在该函数中执行持久阻塞的操作，不然会导致程序不能完全启动的问题</dd></dl>
<h1><a class="anchor" id="seed_context"></a>
项目 Context</h1>
<dl class="section user"><dt>由于框架生成的代码功能模块位于不同的线程中实现，一般持久数据在主线程启动的时候即初始化，那么当其他模块线程要共享数据的时候将通过指针传递来实现，框架生成代码为了降低后续开发代码修改量，将所有传递的指针存放在多个 Context 指针中。Context 对象在初始化时已经创建，在服务启动时会回调 App::Set*Context 函数将用户自定义的 Context 设置进来。</dt><dd></dd></dl>
<dl class="section user"><dt>目前默认是由 AdServerContext / AimsContext / TimerContext 三种 Context 组成。分别用于 AdServer/AIMS/Timer 数据传递, 各个 Context 对象中默认都包含有AdbaseConfig 指针用来通用配置对象的传递</dt><dd></dd></dl>
<dl class="section user"><dt>新增传递数据项的方式：</dt><dd></dd></dl>
<ul>
<li>在 AdbaseConfig.hpp 中修改对应的 AdServerContext 声明 </li>
<li>在 App::Set*Context 函数中 set 传递的数据指针 </li>
<li>在对应的模块中引用 Context 对象</li>
</ul>
<dl class="section user"><dt>Example</dt><dd>例如在应用程序中有一个索引对象 app::Index 在 App 对象中初始化并在 Adserver中使用那么需要做如下修改： <div class="fragment"><div class="line"><span class="comment">// 前置声明</span></div><div class="line"><span class="keyword">namespace </span>app {</div><div class="line">    <span class="keyword">class </span>Index;    </div><div class="line">}</div><div class="line"><span class="comment">// 修改 AdbaseConfig.hpp 声明 app::Index* index;</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>adserverContext {</div><div class="line">    AdbaseConfig* config;</div><div class="line">    <a class="code" href="d6/dd3/namespaceadbase.html#a4e5ed65c9934d78e2f2367574d736ca4">adbase::EventBasePtr</a> mainEventBase;</div><div class="line">    App* app;</div><div class="line">    <a class="code" href="d0/dbe/classadbase_1_1metrics_1_1_metrics.html">adbase::metrics::Metrics</a>* metrics;</div><div class="line">    <span class="comment">// 前后端交互数据指针添加到下面</span></div><div class="line">    app::Index* index;</div><div class="line">} AdServerContext;</div><div class="line"></div><div class="line"><span class="comment">// 将 App 对象中 app::Index 对象 _index 设置到 Context 中 context-&gt;index = _index;</span></div><div class="line"><span class="comment">// {{{ void App::setAdServerContext()</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> App::setAdServerContext(AdServerContext* context) {</div><div class="line">    context-&gt;app = <span class="keyword">this</span>;</div><div class="line">    context-&gt;index = _index;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">// }}}</span></div><div class="line"><span class="comment">// 在 AdServer http 中使用 app::Index 对象</span></div><div class="line">_context-&gt;index-&gt;{索引方法}</div></div><!-- fragment --></dd></dl>
<h1><a class="anchor" id="seed_config"></a>
引入项目配置项</h1>
<p>引入项目的配置项是一个重要的功能，几乎任何项目都会有配置项的, 在 Seed 生成项目中引入用户自定义配置需要如下步骤：</p>
<ul>
<li>在 system.ini 中定义配置 </li>
<li>在 AdbaseConfig.hpp 中 AdbaseConfig 结构体中申明配置项 </li>
<li>在 App::loadConfig() 函数中解析配置</li>
</ul>
<dl class="section user"><dt>Example</dt><dd>比如增加一个 test 配置段 foo 的配置项 <div class="fragment"><div class="line"><span class="comment">// 1. 修改 system.ini</span></div><div class="line">[test]</div><div class="line">foo=1</div><div class="line"><span class="comment">// 2. 增加声明 </span></div><div class="line">....</div><div class="line">    <span class="keywordtype">int</span> foo;</div><div class="line">} AdbaseConfig;</div><div class="line"></div><div class="line"><span class="comment">// 3. 解析配置</span></div><div class="line"><span class="comment">//{{{ void App::loadConfig()</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> App::loadConfig(<a class="code" href="d6/d7c/classadbase_1_1_ini_config.html">adbase::IniConfig</a>&amp; config) {</div><div class="line">    _configure-&gt;foo = config.<a class="code" href="d6/d7c/classadbase_1_1_ini_config.html#a74cb3e3c06ebe2dafbda4aa5a9031216">getOptionUint32</a>(<span class="stringliteral">&quot;test&quot;</span>, <span class="stringliteral">&quot;foo&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">//}}}</span></div></div><!-- fragment --></dd></dl>
<dl class="section note"><dt>Note</dt><dd>具体的解析函数见 adbase::Config</dd></dl>
<h1><a class="anchor" id="seed_http"></a>
HttpServer</h1>
<h1><a class="anchor" id="seed_mc"></a>
McServer</h1>
<h1><a class="anchor" id="seed_head"></a>
AdheadServer</h1>
<h1><a class="anchor" id="seed_aims_in"></a>
AIMS IN</h1>
<h1><a class="anchor" id="seed_aims_out"></a>
AIMS OUT</h1>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Feb 15 2017 18:13:49 for Adbase by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
